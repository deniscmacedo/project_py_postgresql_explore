import psycopg2
import pandas as pd
import json
import os
from  datetime import datetime
#
import re

tupla = (
    '16109313973','19115972710','21120571595','21120571846','23125370928','23125707566'
    '21120571245','21120601073','21120601244','21120601470','21120601594','21120601685'
    '18113720718','21120601379','21120601390','21120601674','21120570344','21120601040'
    '22122591933','15105805592','21120601095','21120601437','21121263362','16109469790'
    '21120570934','21119679164','21119077650','21119322560','21119501876','21119538435'
    '21119542432','21119626180','21120195416','21120532425','21120532447','14103134534'
    '16109480931','19115774942','19114582083','19115494039','17110872675','18111934415'
    '18113721299','21120570333','21120601142','21120366100','19115220044','19115309421'
    '19115313724','19115800634','21119310732','19114875864','19114986355','19115047880'
    '19115832663','19115856468','15105496454','19114519291','19115061905','19115228705'
    '19115300041','19115978341','21120129466','14102458519','19115117090','19115765282'
    '13101628160','19114681427','19115019035','19115021296','19115049116','19115082494'
    '19115176554','19115890014','19115904006','21120649433','22122672740','16109646761'
    '21120570107','21120571008','21120571744','21120601404','21120601540','21120601550'
    '18113575754','21120601302','21120601710','21120642911','21120570231','21120571609'
    '21120571610','21120571664','18114148001','21119263144','21119308300','21119372955'
    '18113299056','20118322319','21119368890','22122574322','16109480873','19114578745'
    '19114746067','19114943873','19115028309','19115174990','19115266748','16109481479'
    '19114702800','19114827282','19114828387','19115358722','19115552838','16109553015'
    '21120571471','21120571880','21120601608','21120649422','22121858641','16109651819'
    '21119768923','21120020387','23124235950','23124349915','16109597972','17111492760'
    '21119244729','21119367933','21119631962','21119997964','21119998005','19115009166'
    '19115262340','19115814650','19115815868','19115091430','19115372440','21120600999'
    '21120570322','21120570978','21120601368','23125374033','24126407748','21120571857'
    '21120601200','21120601426','21120571020','21120571052','21120601131','21120570038'
    '22122248351','15105804920','21120571686','16109508065','21120601583','21120647008'
    '21118951094','21119296212','21120195405','17111139254','19116179605','19116184933'
    '21120570173','21120571562','21120571653','21120571813','21120601084','21120601572'
    '21120663354','22121896470','22121994661','21120570027','21120571755','21120601415'
    '16109790677','21120601109','21120601652','23125854334','16109216434','21120601164'
    '15105890638','21120570923','21120571074','21120571132','15105882640','21120571449'
    '21120601153','22121792180','21120570366','21120571201','23125316729','21120601324'
    '21120601481','21120571380','21120601380','21120601448','23125906176','15108281590'
    '16109563416','17110375160','21120601255','21120601663','13102125405','15106126122'
    '21120570956','21120571256','21120571766','21120601539','16109436157','21119064330'
    '21119092030','21119555140','21119722810','21119997931','16109463193','21120570253'
    '21120601299','24126628521','21120579837','21120601186','21120601346','21120601561'
    '21120601700','22121949838','15105883144','15105920692','17111491724','21120601051'
    '22122672730','24127411977','16109120969','16109789292','21120571347','21120579393'
    '21120601266','21120601335','21120601517','21120601620','16109397237','21120601062'
    '23125496493','17111608286','18113715810','21120567587','21120571540','21120601110'
    '21119045915','21119286150','21119414851','84086556120'
 )
#, 
path_json = f"project_py_postgresql_explore\creds.json"
# path_out = f"project_py_postgresql_reports\{output_folder}\visao_seduc.csv"
# Opening JSON file
with open(path_json) as my_file:
    data = json.load(my_file)
    print(my_file.read())
print(data)
#acesso ao BD sergoias
con=psycopg2.connect(
    dbname=data["dbname"], 
    host=data["host"], 
    port=data["port"], 
    user=data["user"], 
    password=data["password"]
)
#tupla = tuple(cpf_novo)
#tupla = ('6ยบ Ano','7ยบ Ano','8ยบ Ano','9ยบ Ano')
params = {'value': tupla}
query_user = f"""
    select 
        uu.username as "Matricula",
        up.full_name as "Nome_Completo", 
        to_char(uu.date_joined, 'DD/MM/YYYY HH24:MI') as "Data_Cadastro",
        rr."name" as "Regional", 
        ii."name" as "Escola"
    from sergoias.users_user uu
    left join sergoias.users_person up on up.id = uu.person_id
    left join sergoias.institutions_institution_users iiu on iiu.user_id = uu.id
    left join sergoias.institutions_institution ii on ii.id = iiu.institution_id 
    left join sergoias.regionals_regional rr on rr.id = ii.regional_id     
    where uu.username in {tupla}
"""
query_acesso = f"""
    select uu.username,up.full_name,uar.access_at 
    from sergoias.users_user uu
    left join sergoias.users_person up on up.id = uu.person_id 
    inner join sergoias.users_accessrecord uar on uar.user_id = uu.id
    where uu.username in {tupla}
""" 
query_netescola = f"""
    select to_char(nn.access_at, 'DD/MM/YYYY HH24:MI'), url_response->>'login' as login
    from sergoias.netescola_netescolaintegrationlog nn
    where nn.url_response->>'login' in {tupla}
"""    

df = pd.read_sql_query(query_user,con)
con.close()
#
print(df)#
#df_lista2 = df_total.groupby(['username', 'full_name']).agg(list)#.apply(lambda x: x.to_numpy()).
#df_lista2.to_csv("acessos_agg.csv", sep=",", encoding="utf-8", index=True, header=True)
#df.to_csv("user.csv", sep=",", encoding="ISO-8859-1", index=True, header=True)
#print(df_total.describe())
#print(df_lista2.head())
#


